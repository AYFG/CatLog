import { useState } from "react";
import { Link, useNavigate } from "react-router-dom";
import { useMutation } from "@tanstack/react-query";
import { signUp } from "@/utils/supabaseApi";

const Signup = () => {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [confirmPassword, setConfirmPassword] = useState("");
  const [name, setName] = useState("");
  const [errors, setErrors] = useState<{ [key: string]: string }>({});
  const navigate = useNavigate();

  const mutation = useMutation({
    mutationFn: ({ email, password, name }: { email: string; password: string; name: string }) =>
      signUp(email, password, name),
    onSuccess: (data) => {
      console.log("Signup successful:", data);
      // ì´ë©”ì¼ í™•ì¸ì´ í•„ìš”í•œ ê²½ìš° ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
      if (data.data?.user && !data.data.user.email_confirmed_at) {
        alert(
          "íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì´ë©”ì¼ í™•ì¸ ë§í¬ë¥¼ ë°œì†¡í–ˆìŠµë‹ˆë‹¤. ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.",
        );
      } else {
        alert("íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
      }
      navigate("/login");
    },
    onError: (error: any) => {
      console.error("Signup error:", error);
      setErrors({ general: error.message || "íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." });
    },
  });

  const validate = () => {
    const newErrors: { [key: string]: string } = {};

    if (!name) {
      newErrors.name = "ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”";
    }
    if (!email) {
      newErrors.email = "ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”";
    } else {
      // ì´ë©”ì¼ í˜•ì‹ ê²€ì¦
      const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
      if (!emailRegex.test(email)) {
        newErrors.email = "ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤";
      }
    }
    if (!password) {
      newErrors.password = "ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”";
    }
    if (password !== confirmPassword) {
      newErrors.confirmPassword = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤";
    }
    if (password.length < 6) {
      newErrors.password = "ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤";
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (validate()) {
      mutation.mutate({ email, password, name });
    }
  };

  return (
    <div className="min-h-screen bg-snow flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-md w-full space-y-8">
        <div>
          <div className="mx-auto h-12 w-12 flex items-center justify-center rounded-full bg-wePeep">
            <span className="text-2xl">ğŸ±</span>
          </div>
          <h1 className="mt-6 text-center text-3xl font-extrabold text-gray-900">íšŒì›ê°€ì…</h1>
        </div>
        <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
          <div className="space-y-4">
            <div>
              <label htmlFor="name" className="block text-sm font-medium text-gray-700">
                ì´ë¦„
              </label>
              <input
                id="name"
                name="name"
                type="text"
                autoComplete="name"
                required
                className={`mt-1 appearance-none relative block w-full px-3 py-2 border ${
                  errors.name ? "border-red-300" : "border-gray-300"
                } placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-wePeep focus:border-wePeep focus:z-10 sm:text-sm`}
                placeholder="ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"
                value={name}
                onChange={(e) => setName(e.target.value)}
              />
              {errors.name && (
                <p className="mt-1 text-sm text-red-600" role="alert">
                  {errors.name}
                </p>
              )}
            </div>
            <div>
              <label htmlFor="email" className="block text-sm font-medium text-gray-700">
                ì´ë©”ì¼
              </label>
              <input
                id="email"
                name="email"
                type="email"
                autoComplete="email"
                required
                className={`mt-1 appearance-none relative block w-full px-3 py-2 border ${
                  errors.email ? "border-red-300" : "border-gray-300"
                } placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-wePeep focus:border-wePeep focus:z-10 sm:text-sm`}
                placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
              />
              {errors.email && (
                <p className="mt-1 text-sm text-red-600" role="alert">
                  {errors.email}
                </p>
              )}
            </div>
            <div>
              <label htmlFor="password" className="block text-sm font-medium text-gray-700">
                ë¹„ë°€ë²ˆí˜¸
              </label>
              <input
                id="password"
                name="password"
                type="password"
                autoComplete="new-password"
                required
                className={`mt-1 appearance-none relative block w-full px-3 py-2 border ${
                  errors.password ? "border-red-300" : "border-gray-300"
                } placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-wePeep focus:border-wePeep focus:z-10 sm:text-sm`}
                placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
              />
              {errors.password && (
                <p className="mt-1 text-sm text-red-600" role="alert">
                  {errors.password}
                </p>
              )}
            </div>
            <div>
              <label htmlFor="confirmPassword" className="block text-sm font-medium text-gray-700">
                ë¹„ë°€ë²ˆí˜¸ í™•ì¸
              </label>
              <input
                id="confirmPassword"
                name="confirmPassword"
                type="password"
                autoComplete="new-password"
                required
                className={`mt-1 appearance-none relative block w-full px-3 py-2 border ${
                  errors.confirmPassword ? "border-red-300" : "border-gray-300"
                } placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-wePeep focus:border-wePeep focus:z-10 sm:text-sm`}
                placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸"
                value={confirmPassword}
                onChange={(e) => setConfirmPassword(e.target.value)}
              />
              {errors.confirmPassword && (
                <p className="mt-1 text-sm text-red-600" role="alert">
                  {errors.confirmPassword}
                </p>
              )}
            </div>
          </div>

          {errors.general && (
            <div
              className="text-red-600 text-sm text-center p-3 bg-red-50 border border-red-200 rounded-lg"
              role="alert"
            >
              <strong>íšŒì›ê°€ì… ì‹¤íŒ¨:</strong> {errors.general}
              <div className="mt-2 text-xs text-red-500">
                ë¬¸ì œê°€ ì§€ì†ë˜ë©´ ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬(F12)ì˜ Console íƒ­ì„ í™•ì¸í•´ì£¼ì„¸ìš”.
              </div>
            </div>
          )}

          <div>
            <button
              type="submit"
              disabled={mutation.isPending}
              className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-wePeep hover:bg-wePeep/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-wePeep disabled:opacity-50"
            >
              {mutation.isPending ? "ê°€ì… ì¤‘..." : "íšŒì›ê°€ì…"}
            </button>
          </div>

          <div className="text-center">
            <Link to="/login" className="font-medium text-wePeep hover:text-wePeep/80">
              ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? ë¡œê·¸ì¸
            </Link>
          </div>
        </form>
      </div>
    </div>
  );
};

export default Signup;
